% !TEX root=ProposalJavier.tex 
% the previous is to reference main .bib
%% CHAPTER
\chapter{Methodology and Approach}
\label{ch:method}

The methodology is separated into the specific objectives mentioned in \S\ref{ch:objectives}. In this work, a look-up-table (LUT) methodology was implemented to retrieve concentration of water constituents using Landsat-8 imagery. Figure~\ref{fig:retrieval} shows a diagram of this retrieval process. First, the Landsat-8 image data (shown at the top of the figure) needs to be atmospherically corrected. Then, a non-linear optimization routine uses the water pixels (reflectance values) and a LUT of reflectance spectra to estimate concentrations for each water pixels in the scene. The outputs from the process are concentration maps for each water constituents, as shown in Figure~\ref{fig:retrieval}. This process is explained in detail in \S\ref{sec:atmcorr} and \S\ref{sec:retrieval} below.
\begin{figure}[htb]
  \centering
  \includegraphics[height=7cm]{/Users/javier/Desktop/Javier/PHD_RIT/ConferencesAndApplications/NESSF14/latex/Retrieval.pdf}
  \caption{Retrieval process diagram. \label{fig:retrieval} } 
\end{figure}

\section{Over-Water Atmospheric Correction} 
\label{sec:atmcorr}
The first objective in this research is to identify a suitable approach to atmospherically correct the type of dataset provided by the OLI sensor. This is a complex task to perform over water because the signal leaving the water that reaches the sensor is very small compared to the signal reaching the sensor from atmospheric scattering. Most of the atmospheric correction algorithms used for Ocean Color Satellites (i.e. CZCS, MODIS, SeaWiFS) are based in the work done by \cite{Gordon:1994} (also described in \cite{Gordon:1997}).

However, some of the atmospheric correction algorithms applied to Ocean Color Satellites are not suitable for highly turbid coastal waters because the {\it black pixel assumption} cannot be applied to these types of waters~\cite{Patt2003}. Several methods for atmospheric compensation are be investigated in this research.

Some atmospheric correction methods described in this section will use the notation used by \cite{Gordon:1994} and \cite{Ruddick:2000bs} who define the apparent reflectance as 

\begin{equation}\label{eq:rho}
  \rho = \frac{\pi L}{F_o \cos{\theta}}
\end{equation}
where $L$ is upward radiance in the given viewing direction, $F_o$ is exoatmospheric irradiance, and $\theta$ is the solar-zenith angle. \autoref{eq:rho} allows a direct transformation from radiance to reflectance and vice versa. Therefore, taking in account all its contributors, the governing equation for sensor-reaching reflectance can be expressed as

\begin{equation}\label{eq:rho_t}
  \rho_t(\lambda) = \rho_r(\lambda) + \rho_a(\lambda) + \rho_{ra}(\lambda) + T_v[\rho_w(\lambda) + \rho_{wc}(\lambda)]
\end{equation}
where:\\
\indent $\rho_t(\lambda)$ is the reflectance at the top of the atmosphere \\
\indent $\rho_r(\lambda)$ is the reflectance due to multiple scatter by air molecules only (Rayleigh scattering)\\
\indent $\rho_a(\lambda)$ is the reflectance due to multiple scatter by aerosols only\\
\indent $\rho_{ra}(\lambda)$ is the reflectance due to the interaction between Rayleigh and aerosol scattering\\
\indent $T_v(\lambda)$ is the diffuse atmospheric transmittance from the water to the sensor\\
\indent $\rho_{wc}(\lambda)$ is the reflectance due to solar photons reflecting off the air-water interface (from whitecaps and glint or glitter)\\
\indent $\rho_w(\lambda)$ is the water-leaving reflectance

In order to perform the water constituent retrieval, we need to solve for only the $\rho_w(\lambda)$ term in \autoref{eq:rho_t}, which would be an easy task if all the rest of the terms were known. Unfortunately, the only term known {\it a priori} is the $\rho_t(\lambda)$, which is precisely the image of the scene itself. The main difference among the methods based on \cite{Gordon:1994} is in the approach used to estimate $\rho_a(\lambda) + \rho_{ra}(\lambda)$ in the visible (VIS) using an estimation of $\rho_a(\lambda) + \rho_{ra}(\lambda)$ in the near infrared (NIR).

This section describes the different alternatives to obtain the rest of the terms in \autoref{eq:rho_t}.

\subsection{Solar-Glint Removal Algorithm}
\label{subsec:glintremoval}
The first step to solve \autoref{eq:rho_t} is to find the term due to glint, $\rho_{wc}(\lambda)$ and remove it from the total signal. This term $\rho_{wc}(\lambda)$ can be ignored in some cases since ocean-color sensors are designed to be tilted to avoid the specular image of the sun. However, Landsat-8 is not cataloged as an ocean-color satellite and it may need to be corrected for the glint effect depending on the location of the water in the scene.

The method to remove the sun glint effect chosen for this study is the method suggested by \cite{Hedley:2005}, which is a revised version of the method suggested by \cite{Hochberg:2003}. The method described by Hochberg was developed for high spatial resolutions where glint effects occur at physical scales comparable to image pixels ($<10m$) as opposed to methods developed for ocean-color sensor, which tend to have large physical scales ($>1km$).
The method presented by Hochberg is sensitive to outlier pixels and it needs to mask the land and cloud areas before deglinting. The method suggested by Hedley overcomes these inconveniences. This method assumes that (a) the brightness in the NIR is composed only of sun glint and a spatially constant ambient NIR component associated with NIR backscatter in the atmosphere (if the image is not atmospherically corrected), and (b) that the amount of sun glint in the visible bands is linearly related to the brightness (glint) in the NIR band. 

The first assumption is true for waters that are not highly turbid since water is relatively opaque to NIR wavelength ($700-1000nm$). The second assumption of a linear relationship between NIR brightness and the amount of sun glint in the visible bands relies on the fact that the real index of refraction, which is associated with the reflection in the water surface, is nearly equal for NIR and visible wavelengths (\cite{Mobley1994}). As a result, the amount of light reflected in the visible bands is proportional to the amount of light reflected in the NIR, and therefore, a linear relationship can be established among them. The first step is to establish this relationship. This is accomplished by solving a linear regression between NIR and visible bands using one or more ROIs from the water pixels in the image where some sun glint is noticeable, and their pixels values would be of similar values otherwise. An example of a ROI could be a ROI over deep water in the lake. A slope is determined from solving this linear regression with NIR pixel values in the ROI as the independent variable ($x$-axis) and a particular visible band as the dependent variable ($y$-axis), as shown in \autoref{fig:regressiohedley}. If the regression slope for band $i$ is $b_i$, then sun-glint corrected pixel brightness in band $i$ can be obtained by applying the following formula
\begin{equation}\label{eq:deglint}
  R_i' = R_i - b_i(R_{NIR}-min_{NIR})
\end{equation}
where $R_i'$ is the sun-glint corrected pixel value in band $i$, $R_i$ is the pixel value in the visible band $i$, $R_{NIR}$ is the NIR pixel value, and $min_{NIR}$ is the ambient NIR level and it represents the NIR brightness of a pixel with no sun glint. $min_{NIR}$ can be the minimum NIR value in the ROI used in the linear regression or as the minimum NIR in the water pixels. This method has the advantage that it operates purely on the relative magnitudes of values, and therefore the absolutes magnitudes are not important. The author suggests use of ROIs from different regions in the image, including ROIs where there is not glint at all. The different steps are summarized as follows.

\noindent{\bf Solar-Deglinting Algorithm Summary}\\
{\bf Step 1:} Select a ROI in the image where there is a range of sun glint, but where the brightness values would be uniform otherwise.\\
{\bf Step 2:} Determine $min_{NIR}$ by selecting the minimum NIR value of ROI.\\
{\bf Step 3:} Determine the slope $b_i$ from a linear regression between the NIR values ($x$-axis) and the visible band $i$ to be deglinted ($y$-axis).\\
{\bf Step 4:} Deglint all pixels in the image using \autoref{eq:deglint}.\\
{\bf Step 5:} Repeat step 1-4 for each band to be deglinted.

\begin{figure}[!ht]
  \centering
  \includegraphics[width=11cm,clip=true]{/Users/javier/Desktop/Javier/PHD_RIT/Latex/Proposal/Images/RegressionHedley.png}
  \caption{Linear regression used in the deglinting process (Note: image taken from \cite{Hedley:2005}). \label{fig:regressiohedley} } 
\end{figure}

Some considerations need to be taken into account in order to apply this method. The first assumption is only valid when there is no water with high concentration of sediment present in the image, so precautions have to be taken to avoid highly turbid water in the image. As a way to overcome this problem, the OLI's SWIR band (band 6) will be used instead of the NIR band since the water-leaving signal is negligible at $1600nm$, as suggested by \cite{GeraceThesis}. The real part of the index of refraction is still nearly equal for all wavelengths in the VNIR/SWIR, and therefore the second assumption of a linear relationship between NIR values and the amount of sun glint in the visible band is still valid. Other consideration is that if the ROIs selected include non-submerged objects (i.e. buoys, boats, land), this algorithm could output negative values. Therefore, it is recommended to mask all non-submerged objects before applying this method.

\missingfigure{Example of deglinting}

The purpose of the deglinting process is to find the term $T_v\rho_{wc}$ in \autoref{eq:rho_t} and subtract it from the total TOA reflectance $\rho_t$,

\begin{equation}\label{eq:rhodeglint}
  \rho_t(\lambda)-T_v(\lambda)\rho_{wc}(\lambda) = \rho_r(\lambda)+\rho_a(\lambda)+\rho_{ra}(\lambda)+T_v(\lambda)\rho_{w}(\lambda)
\end{equation}

Once water pixels in the image are deglinted, the next step is to atmospherically correct the image in order to isolate $\rho_w$ from \autoref{eq:rhodeglint}.



\subsection{Model-based ELM}
The first method will be a model-based empirical line method (ELM) based on previous work done by \cite{Gerace:2013} and \cite{Gerace:2012}  for simulated OLI data. While this new method is based on the traditional ELM method (see \S\ref{subsec:ELM}), this model-based ELM method tries to avoid the measurement of ground truth at every sensor overpass over the scene by using pseudo-invariant features (PIF) \index{pseudo-invariant features (PIF)} in the scene as one target along with an estimation of water reflectivity for an open lake region for the other target. The two targets used in this model-based ELM to solve the regression in \autoref{eq:ELM} are referred to in this documents as the {\it bright pixel} \index{bright pixel} and the {\it dark pixel}\index{dark pixel}.

\subsubsection{Pseudo-Invariant Feature Extraction}

This method employs a PIF pixel extraction \cite{Schott:1988} to mask urban landscape from both the reflectance product and the Landsat-8 image for the bright pixel determination. Pseudo-invariant targets are defined as targets whose reflectivity properties do not change rapidly between different times of collection. Examples of pseudo-invariant target are urban features in the scene.  The PIF extraction isolates the pseudoinvariant features from the digital imagery. In our case, the PIF are the man-made urban features in a scene. A flowchart of the process is shown in \autoref{fig:PIFflowchart}. 

\begin{figure}[htb]
	\centering
  \begin{tikzpicture}[node distance=0.75cm, auto]
          \tikzset{
                  basenode/.style={rectangle,rounded corners,draw=black,very thick, inner sep=1em, minimum size=3em, text centered,text width=2cm},
                  productnode/.style={ellipse,rounded corners,draw=black, very thick, text centered,text width=1.5cm},
                  myarrow/.style={->,>=stealth',thick, double = black},
                  mylabel/.style={text width=7em, text centered}
          }
          % SWIR branch
          \node[basenode] (SWIR) {SWIR 2\\ Band};
          \node[basenode, below=of SWIR] (TS1) {Mask by Threshold (upward)};
          \node[align=left, right=0.0 of TS1] (C1) {Urban\\Veget.\\Water};
          \node[align=left, right=-0.15 of C1] (C2) {ON\\ON\\OFF};

          % Ratio branch
          \node[basenode, right=2.5cm of SWIR] (Ratio) {Ratio\\ NIR Band/ Red Band};
          \node[basenode, below=of Ratio] (TS2) {Mask by Threshold (downward)};
          \node[align=left, right=0.0 of TS2] (C3) {Urban\\Veget.\\Water};
          \node[align=left, right=-0.15 of C3] (C4) {ON\\OFF\\ON};

          % AND
          \path (TS1.south)--(TS2.south) node[pos=.5,below=2cm] (AND) {.AND.};


          % PIF Mask
          \node[basenode, below=of AND] (PIFMask){PIF Mask};
          \node[align=left, left=0.85 of PIFMask] (C5) {Urban\\Veget.\\Water};
          \node[align=left, right=-0.15 of C5] (C6) {ON\\OFF\\OFF};

          \node[basenode, below=of TS2,right=2.0cm of AND] (Image) {Image};
          \path (Image.south)--(PIFMask.east) node[below=of Image,right=2cm of PIFMask] (AND2) {.AND.};
          \node[basenode, right=2cm of AND2] (PIFIm){PIF Image};

          \draw[myarrow] (SWIR)--(TS1);
          \draw[myarrow] (Ratio)--(TS2);
          \draw[myarrow] (TS1)--(AND);
          \draw[myarrow] (TS2)--(AND);
          \draw[myarrow] (AND)--(PIFMask);
          \draw[myarrow] (Image)--(AND2);
          \draw[myarrow] (PIFMask)--(AND2);
          \draw[myarrow] (AND2)--(PIFIm);
  \end{tikzpicture}
\caption{Illustration of the logic used to segment PIF features. \label{fig:PIFflowchart}}
\end{figure}

The PIF extraction process is illustrated in \autoref{fig:PIFflowchart}. The PIF extraction from digital imagery proceeds in the following fashion. An infrared-to-red ratio image is very effective in the classification of water, vegetation, and urban features. The vegetation in this ratio image will tend to have a high brightness when compared to the urban features and water brightness. This infrared-to-red ratio image can be derived from the quotient of the NIR band (band 4 for Landsat-5; band 5 for Landsat-8) and the red band (band 3 for Landsat-5,band 4 for Landsat-8), as seen in \autoref{fig:PIFflowchart}. This ratio image is thresholded from the high digital count values downward to create a mask so the high brightness pixels are eliminated (vegetation pixels) from the image, that is, these pixels are set to a value of zero and the rest (water and urban pixels) to a value of one. The SWIR 2 band (band 7 in Landsat-5 and Landsat-8) is used to eliminate the water pixels from the previous mask since water has nearly zero reflectance in this spectral region. This SWIR 2 band is thresholded from the low brightness values upward. Water pixels will exhibit a low value when compare to the rest of the pixels. A mask is created by assigning a value of zero to the low brightness pixels (water pixels) and a value of one to the rest (urban features and vegetation). Finally, the two masks created are combined using a logical .AND., resulting in a mask that will have a value of one only in the urban feature pixels, i.e. the PIFs, as shown in \autoref{fig:PIFflowchart}. This mask will be named ``PIF mask'' for the rest of this document. An example of a PIF mask is illustrated in \autoref{fig:PIFmask}. A false color image of Downtown Rochester, NY is shown on the left (vegetation in red) and a RGB image of the same area with the PIF mask applied is shown on the right (urban features in bright color while masked pixels in black).

% \vspace{-.3cm}
\begin{figure}[htb]
  \begin{minipage}[c]{0.48\linewidth}
    \centering
      \includegraphics[trim=30 0 30 0,clip,height=6cm]{/Users/javier/Desktop/Javier/PHD_RIT/Latex/Proposal/Images/DTROCL8falsecolor.jpg}  
    % \vspace{1.5cm}
    \centerline{(a)}\medskip
  \end{minipage}
  \hfill
  \begin{minipage}[d]{0.48\linewidth}
    \centering
      \includegraphics[trim=30 0 30 0,clip,height=6cm]{/Users/javier/Desktop/Javier/PHD_RIT/Latex/Proposal/Images/PIFmaskApplied.jpg}
    % \vspace{1.5cm}
    \centerline{(b)}\medskip
  \end{minipage}
  \caption{PIF mask determination. (a) False color image, with vegetation in red and (b) PIF mask over downtown Rochester. \label{fig:PIFmask} } 
\end{figure}

\subsubsection{Bright Pixel Determination}

The PIF mask is used to determine the bright pixel spectra in both radiance (from the Landsat-8 image) and reflectance values (from the Landsat Surface Reflectance CDR \cite{LandsatCDR} image). See \S\ref{sec:CDR} for more details about the Landsat reflectance product. The Landsat reflectance product was available for a total of 9 Landsat 5 scenes where clear sky conditions were acceptable. One PIF mask for each of these 9 Landsat reflectance product scenes was created using ENVI. In addition, one PIF mask was created from the Landsat-8 radiance image. Finally, these 10 PIF masks were combined using a logical .AND. to create a ``master'' PIF mask \index{master PIF mask} in order to only include the PIF pixels coincident in all images. This is necessary because there is a no perfect geometry registration among all images. Then, the statistics were calculated in ENVI for each scene using this master PIF mask. An example of the statistical results obtained from ENVI are shown in \autoref{fig:PIFstats}.(a) and \autoref{fig:PIFstats}.(b) for one scene of the Landsat reflectance product (in reflectance units) and for the Landsat-8 image (in radiance units), respectively. The mean value is shown in black solid line, the green solid lines are the mean plus standard deviation and the mean minus standard deviation, and the red solid lines are the maximum and minimum values for each band. The mean values for each one of the 9 scenes are shown in \autoref{fig:ZenithCorr}. 

\begin{figure}[!ht]
  \begin{minipage}[c]{0.48\linewidth}
    \centering
      \includegraphics[height=9cm]{/Users/javier/Desktop/Javier/PHD_RIT/Latex/Proposal/Images/PIFstatCDR.png}  
    % \vspace{1.5cm}
    \centerline{(a)}\medskip
  \end{minipage}
  \hfill
  \begin{minipage}[d]{0.48\linewidth}
    \centering
      \includegraphics[height=9cm]{/Users/javier/Desktop/Javier/PHD_RIT/Latex/Proposal/Images/PIFstatL8.png}
    % \vspace{1.5cm} 
    \centerline{(b)}\medskip
  \end{minipage}
  \caption{Bright pixel determination using the PIF mask in ENVI. Statistics with the PIF mask applied for (a) Landsat reflectance product (in reflectance units) and (b) statistics for Landsat-8 image (in radiances units). \label{fig:PIFstats} } 
\end{figure}

\subsubsection{Solar Zenith Correction}

As seen in \autoref{fig:ZenithCorr}, the PIF reflectance values for each scene are not the same, but a high correlation between the reflectance values and the solar zenith angle for each band was found. A linear relationship was determined for each band by applying a linear regression in MATLAB and the $R^2$ and root mean square error (RMSE) values were calculated as a way to measure this correlation. This linear relationship has the form 
\begin{equation}
	y = m*x + y_0
	\label{eq:linear}
\end{equation}
where $x$ represents the solar zenith angle and $m$ the reflectance value. \autoref{fig:Band1Corr} shows the reflectance values versus the solar zenith angle for band 1 for the 9 Landsat reflectance scenes and the calculated linear relationship. The values $m$ and $y_0$ found for all the bands are shown in \autoref{tab:ZenithCorr} along with the $R^2$ and RMSE values for each band. Note that the RMSE values in the visible are small. It can been seen in \autoref{tab:ZenithCorr} that the $R^2$ values are bigger than $0.9$ for all bands, which suggests there is a high correlation between the reflectance values and the solar zenith angle. As a conclusion, these results show that the reflectance values remain constant over time and depend of the solar zenith angle of the sensor. This is an expected behavior since intuitively the zenith angle influences the length of shadows in the scene, and the amount of shadow in the scene affects the brightness of the pixels, therefore the reflectance values. This is illustrated in \autoref{fig:shadow}, where two different solar zenith angles ($\theta_1$ and $\theta_2$) are shown, with $\theta_1<\theta_2$. A smaller zenith angle ($\theta_1$ in \autoref{fig:shadow}) means that the sun is positioned almost straight overhead, therefore there are smaller shadows from buildings in the scene. On the other hand, if the sun is closer to the horizon ($\theta_2$ in \autoref{fig:shadow}), i.e. larger zenith angle, the shadows produced by buildings will be bigger. From \autoref{fig:shadow}, one can intuitively conclude at least that the length of shadow is proportional to the zenith angle $\theta$, and consequently inversely proportional to $\cos{\theta}$.

\begin{figure}[!ht]
    \centering
    \includegraphics[height=13cm]{/Users/javier/Desktop/Javier/PHD_RIT/Latex/Proposal/Images/Shadow.png}
  \caption{Shadow size as function of zenith angle. \label{fig:shadow} } 
\end{figure}

The Landsat-8 image has associated a particular solar zenith angle. The previous linear relationships calculated will help to estimate the values for the reflectance value of the bright pixel for that particular solar zenith angle. For example, the solar zenith angle for the 09-19-13 Landsat-8 scene is equal to $45^\circ$, and therefore $x=45^\circ$ in \autoref{eq:linear}. The reflectance values for $x=45^\circ$ are shown in the last column of \autoref{tab:ZenithCorr} and plotted in \autoref{fig:ZenithCorr} as red asterisks.
%--------------------------------------
% \vspace{.5cm}
\begin{table}[htb]
\caption{ Zenith angle correction parameters. \label{tab:ZenithCorr} } 
\centering
\begin{tabular}{c|c|c|c|c|c} 
 \bfseries{Band n} & \bfseries{$m$}      & \bfseries{$y_0$}    & \bfseries{$R^2$}     & \bfseries{$RMSE$} & $y(x=45^\circ)$   \\ \hline \hline
 Band 1 & -0.000412 & 0.122631 & 0.937155 & 0.001705 &  0.1041\\
 Band 2 & -0.000634 & 0.147424 & 0.934344 & 0.002685 &  0.1189\\
 Band 3 & -0.000756 & 0.161421 & 0.976599 & 0.001869 &  0.1274\\
 Band 4 & -0.001316 & 0.220031 & 0.906946 & 0.006733 &  0.1608\\
 Band 5 & -0.001148 & 0.217231 & 0.903702 & 0.005984 &  0.1656\\
 Band 6 & -0.001159 & 0.206725 & 0.929626 & 0.005096 &  0.1546\\  
 \end{tabular}
\end{table}

\begin{figure}[htb]
  	\centering
  	\includegraphics[height=7cm]{/Users/javier/Desktop/Javier/PHD_RIT/Latex/Proposal/Images/ZenithCorrelation.eps}
  \caption{Correlation for band 1. \label{fig:Band1Corr} } 
\end{figure}

\begin{figure}[htb]
  	\centering
  	\includegraphics[height=7cm]{/Users/javier/Desktop/Javier/PHD_RIT/Latex/Proposal/Images/ZenithCorrection.eps}
  \caption{Bright pixel for 9 different scenes. \label{fig:ZenithCorr} } 
\end{figure}
Because the Landsat reflectance products was not available for Landsat-8 at the moment of writing this documents, it was necessary to estimate a theoretical reflectance value for the coastal band for Landsat 5 in order to match with the Landsat-8 bands. To accomplish this, it was assumed that the coastal band would exhibit a similar trend as the blue and green bands. Hence, a straight-line that passes through the blue and green band values was used to extrapolate the value of the coastal band, as seen in \autoref{fig:Extrapol}, where the estimation of this reflectance value for the coastal band is shown at $443 [nm]$ and the straight-line is shown as a black solid line. It is expected the Landsat reflectance product will be available for Landsat-8 in the future. Therefore, the Landsat-8 reflectance could be used directly, and the previous step would not be necessary. Finally, the reflectance spectra for the bright pixel is shown in \autoref{tab:brightref}. As was mentioned previously, the radiance spectra for the bright pixel is obtained by applying the master PIF mask to the Landsat-8 image (see \autoref{fig:PIFstats}.(b)).

\begin{table}[htb]
\caption{ Reflectance spectra for the bright pixel. \label{tab:brightref} } 
\centering
\begin{tabular}{l|c} 
 \bfseries{Band} & \bfseries{Reflectance values}\\ \hline \hline
 Band 1 (Coastal Band) &  0.0965 \\
 Band 2 (Blue Band) &  0.1039 \\
 Band 3 (Green Band) &  0.1186 \\
 Band 4 (Red Band) &  0.1270 \\
 Band 5 (NIR Band) &  0.1601 \\
 Band 6 (SWIR 1 Band) &  0.1650 \\ 
 Band 7 (SWIR 2 Band) &  0.1539 \\ 
 \end{tabular}
\end{table}

\begin{figure}[htb]
  	\centering
  	\includegraphics[height=7cm]{/Users/javier/Desktop/Javier/PHD_RIT/Latex/Proposal/Images/Extrapolation.eps}
  \caption{Extrapolation for the coastal band. \label{fig:Extrapol} } 
\end{figure}

\subsubsection{Black Pixel Determination}
\label{subsubsec:blackpixel}

The reflectance spectra for the dark pixel is obtained from Ecolight, which is a version of Hydrolight that runs faster because it only calculates the radiance for the nadir angle and not in all directions (\cite{MobleyHEtech}). This Ecolight run represents a ROI present in the Landsat-8 radiance image. IOPs and concentrations measurements taken in the field from the same ROI are input to Ecolight. The Case 2 model in Ecolight is used to generate a remote sensing reflectance ($R_{rs}$). This model is a generic four-component (pure water, chlorophyll-bearing particles, CDOM, and mineral particles) IOP model \cite{MobleyHEtech}. The Case 2 model in Ecolight requires us to specify the IOPs of each component one at a time. This includes concentration, absorption and scattering coefficient spectra and phase function for each component. The IOPs for each component provided to Ecolight are used to generate the reflectance spectra for the dark pixel are explained below.

\autoref{tab:ONTNSconc} shows the constituent concentration for two different water samples from the data collection on September, 19th, 2013. These water samples were collected from the nearshore of Lake Ontario (labeled as ONTNS) and from the southern part of Long Pond (labeled as LONGS), and they represent two scenarios with totally different characteristics. The water sample ONTNS was used to generate the reflectance spectra for the dark pixel in Ecolight. The concentrations for each component were set to be constant with depth with the values shown in \autoref{tab:ONTNSconc}. 
\vspace{.5cm}
\begin{table}[!ht]
\caption{ Water samples concentration for the September, 19th, 2013 collections. \label{tab:ONTNSconc} } 
\centering
\begin{tabular}{c|c|c|c} 
 \bfseries{Sample} & \bfseries{$X_{Chl}$} & \bfseries{$a(\lambda_0=440)$}& \bfseries{$X_{SM}$}\\
 & $[\mu g/L]$ & $[1/m]$ & $[mg/L]$ \\ \hline \hline
ONTNS & 0.48 & 0.1151 & 1.6\\ 
LONGS & 112.76 & 1.1953 & 46.0\\ 
 \end{tabular}
\end{table}

The absorption properties for the component chlorophyll were input by user-supplied data files containing mass-specific absorption coefficient as a function of wavelength. This mass-specific absorption spectra is shown in \autoref{fig:CHLaast}. This data was obtained from lab measurements of absorption coefficient spectra for the water sample ONTNS with a {\todo{describe method} spectrophotometric method}. The spectrophotometric method yields absorption coefficients, which are converted to mass-specific absorption coefficient by dividing the absorption coefficient spectra by the concentration. This chlorophyll concentration was determined in lab by a {\todo{describe method} spectrophotometric method} as well. For the chlorophyll scattering properties, the same mass-specific scattering coefficient data used in \cite{Raqueno:2000} and \cite{Raqueno:2003} were utilized. This data is shown in \autoref{fig:CHLbast}. A Fournier-Forand (FF) phase function with backscatter fraction 0.010 was selected as the phase function for the chlorophyll. The details about the selection of this phase function will be described {\todo{correct?!} below}.
\begin{figure}[htb]
  	\centering
  	\includegraphics[height=7cm]{/Users/javier/Desktop/Javier/PHD_RIT/Latex/Proposal/Images/CHLaastJavier.eps}
  \caption{Chlorophyll mass-specific absorption spectra used for the determination of the reflectance spectra of the dark pixel in HydroLight. \label{fig:CHLaast} } 
\end{figure}


\begin{figure}[htb]
  	\centering
  	\includegraphics[height=7cm]{/Users/javier/Desktop/Javier/PHD_RIT/Latex/Proposal/Images/CHLbastRolo.eps}
  \caption{Chlorophyll mass-specific scattering spectra used for the determination of the reflectance spectra of the dark pixel in HydroLight. \label{fig:CHLbast} } 
\end{figure}

For the CDOM component, the absorption specification was the following. First, the absorption coefficients were determined by spectrophotometric measurements in lab for the ONTNS water sample. This data is shown in \autoref{fig:CDOMa}. Then, the data were normalized by the absorption value $a(\lambda_0)=0.1151[1/m]$ at the reference wavelength $\lambda_0=440nm$, so that $a^*(\lambda_0)=1$. This normalized data is shown in \autoref{fig:CDOMaast} as purple dots. An exponential curve with the following equation
\begin{equation}
	\label{eq:CDOMabs}
	a^*(\lambda)=a^*(\lambda_0)\exp{\left[-\gamma(\lambda-\lambda_0)\right]}
\end{equation}
was fitted to the normalized data. It was determined that the decay constant $\gamma=0.0126$. The fitted curve is illustrated in \autoref{fig:CDOMaast} in solid line. The parameters of this fitted curve are input in Ecolight to specify the CDOM specific absorption $a^*$, and $a(\lambda_0)=0.1151[1/m]$ to specify the dependence of the CDOM absorption at a reference wavelength.

\begin{figure}[!ht]
  	\centering
  	\includegraphics[height=7cm]{/Users/javier/Desktop/Javier/PHD_RIT/Latex/Proposal/Images/ONTNS_CDOMabs.eps}
  \caption{CDOM absorption coefficient spectra used for the determination of the reflectance spectra of the dark pixel in HydroLight. \label{fig:CDOMa} } 
\end{figure}

\begin{figure}[!ht]
  	\centering
  	\includegraphics[height=7cm]{/Users/javier/Desktop/Javier/PHD_RIT/Latex/Proposal/Images/ONTNS_CDOMfitting.eps}
  \caption{CDOM mass-specific absorption spectra used for the determination of the reflectance spectra of the dark pixel in HydroLight. \label{fig:CDOMaast} }
\end{figure}

The mineral mass-specific absorption coefficient was determined in the same fashion as for the chlorophyll mass-specific absorption coefficient from lab measurements of the ONTNS water sample. The mineral mass-specific absorption coefficient are shown in \autoref{fig:SMaast}. The mineral mass-specific scattering coefficient was the same used by \cite{Raqueno:2000} and \cite{Raqueno:2003} and are shown in \autoref{fig:SMbast}.

\begin{figure}[!ht]
  	\centering
  	\includegraphics[height=7cm]{/Users/javier/Desktop/Javier/PHD_RIT/Latex/Proposal/Images/SMaastJavier.eps}
  \caption{Mineral mass-specific absorption spectra used for the determination of the reflectance spectra of the dark pixel in HydroLight. \label{fig:SMaast} } 
  % \vspace{0.5cm}
\end{figure}

\begin{figure}[!ht]
  	\centering
  	\includegraphics[height=7cm]{/Users/javier/Desktop/Javier/PHD_RIT/Latex/Proposal/Images/SMbastRolo.eps}
  \caption{Mineral mass-specific scattering spectra used for the determination of the reflectance spectra of the dark pixel in HydroLight. \label{fig:SMbast} } 
\end{figure}

\todo{update with new Rrs measurement}The following approach was used to determine phase function for both the chlorophyll and mineral particle components. Ecolight was run several times with the different phase function from the library of discretized Fournier-Forand phase functions files supplied with Ecolight 5.2 to created a LUT of reflectance spectra, but maintaining the rest of the parameters the same. These parameters correspond to the ONTNS water sample. The different reflectance spectra generated as output were compared with the reflectance measured in situ. The best match was determining by choosing the lowest root mean squared error (RMSE) between the reflectance measured in situ and the simulated reflectance spectra.

It was determined that the best matched corresponds to the discretized Fournier-Forand phase function with a backscatter equal to $0.010$, i.e. $1\%$ of backscatter fraction (FFbb010.dpf). Therefore, this discretized Fournier-Forand phase function is used for both the chlorophyll and mineral particle. \autoref{fig:BestMatchONTNS} illustrated the reflectance measured in situ (red solid line) and the best match reflectance from the LUT (blue solid line), generated with a discretized Fournier-Forand phase function of 0.010 backscatter fraction. It can be seen in \autoref{fig:BestMatchONTNS} that both spectra agree in values above $550nm$, but not below this wavelength. This suggests that there is still need for improvement in the determination of the phase function and rest of the parameters in the Ecolight model.

The following parameters were input to Ecolight in order to simulate the Landsat acquisition conditions. The illumination conditions were input to Ecolight by specifying the solar zenith angle and day of the year that matched the Landsat-8 image. Internal sources and inelastic scatter were not included in the simulations. The wavelength range was $[400nm,1000nm]$, with a $1nm$ step. Default values for the air-water surface conditions were used, with a windspeed equal to $5m/s$, a real index of refraction equal to $n=1.34$, and the semi-empirical sky model (based on RADTRAN-X). Recall that Hydrolight uses a Cox-Munk air-water surface model that parameterizes gravity and capillary waves via the wind speed \todo{reference to Cox-Munk}. Finally, The bottom boundary condition used was ``the water column is infinitely deep.''

This best matched is used as the reflectance spectra of the dark pixel in the model-based ELM method. This reflectance is further spectrally sampled to the Landsat-8 response. 

\begin{figure}[htb]
  	\centering
  	\includegraphics[height=7cm]{/Users/javier/Desktop/Javier/PHD_RIT/Latex/Proposal/Images/RefWithFFbbONTNS.eps}
  \caption{Reflectance for ONTNS sample and best matching from HydroLight. \label{fig:BestMatchONTNS} } 
\end{figure}

The radiance spectra for the dark pixel is obtained from a ROI in the water present in the Landsat-8 image that could be considered a dark region (i.e. open lake). Statistics are computed in this dark region, and the mean values in each band is used as radiance spectra for the dark pixel.

\missingfigure{figure showing and ROI in the Landsat-8 image and statistic in ENVI}

As a review, \autoref{fig:ELMpxsENVI} shows the different spectra used to perform the model-based ELM, where four different spectra can be seen: one reflectance and one radiance spectra for the bright pixel (obtained using the PIF extraction over the Landsat reflectance product and Landsat-8 image, respectively), one reflectance spectra for the dark pixel (obtained from HydroLight), and one radiance spectra for bright pixel (obtained from the statistics of a ROI over water in the Landsat-8 image). These spectra are used to atmospherically correct the Landsat-8 image using the ENVI Classic software \cite{ENVIUserGuide}. This is performed using the ``Empirical Line'' algorithm of the ``Calibration Utilities'' in ENVI classic, where the Landsat-8 image is used as the input image, and the reflectance spectra are labeled as ``field spectra'' and the radiance spectra are labeled as ``data spectra.'' The product of this process is an image in reflectance values, which will be used to perform the retrieval of water constituents described in \S\ref{sec:retrieval} below. Note that the Landsat-8 image used was not glint corrected.

\begin{figure}[htb]
  \centering
  \includegraphics[width=14cm,clip=true]{/Users/javier/Desktop/Javier/PHD_RIT/Latex/Proposal/Images/ELMpixelsENVI.pdf}
  \caption{Bright and Dark pixels used in ENVI to apply ELM. \label{fig:ELMpxsENVI} } 
  % \vspace{0.5cm}
\end{figure}
\todo{include summary of model-based ELM}

% ----------------------------
\subsection{SeaWiFS Algorithm for Case 1 Waters}
\label{subsec:gordon}
The following algorithm is based in the method developed by \cite{Gordon:1994} for retrieval of water-leaving radiance and aerosol optical thickness over the oceans with SeaWiFS. The method develop by \cite{Gordon:1994} is still applied to the basic SeaWiFS and MODIS atmospheric correction algorithms for Case 1 water (\cite{IOCCG:2010}).

The first step in this algorithm is performing a Rayleigh scattering correction, which means to subtract the reflectance due to Rayleigh scatter $\rho_r$ from the total TOA reflectance $\rho_t$ in \autoref{eq:rhodeglint}. In the SeaWiFS/MODIS algorithm, the Rayleigh scatter component is computed from the Rayleigh LUTs, which were calculated using the vector radiative transfer theory (\cite{Wang:1991,IOCCG:2010}). For this work, this Rayleigh scattering component $\rho_r$ can be calculated directly from MODTRAN for the particular illumination and viewing geometry of the sun and the sensor in multiple-scatter mode but without aerosol. In the SeaWiFS/MODIS atmospheric correction algorithm, the whitecap reflectance $\rho_{wc}(\lambda)$ is modelled using input of the sea surface wind speed, and the TOA sun glint component is mostly masked out (\cite{IOCCG:2010}). After calculating this Rayleigh scatter and whitecap component, \autoref{eq:rhodeglint} becomes 
\begin{equation}\label{eq:rhodeRayliegh}
 \rho_c(\lambda) = \rho_t(\lambda)-\rho_r(\lambda)-T_v(\lambda)\rho_{wc}(\lambda) = \rho_a(\lambda)+\rho_{ra}(\lambda)+T_v(\lambda)\rho_{w}(\lambda)
\end{equation}
where $\rho_c(\lambda)$ is the Rayleigh-corrected reflectance. 

If we define the total multiple-scattering aerosol reflectance $\rho_{am}$ as
\begin{equation}\label{eq:rhoam1}
  \rho_{am}(\lambda) = \rho_a(\lambda)+\rho_{ra}(\lambda)
\end{equation}
then \autoref{eq:rhodeRayliegh} becomes
\begin{equation}\label{eq:rhoam}
 \rho_c(\lambda) = \rho_{am}(\lambda) + T_v(\lambda)\rho_{w}(\lambda)
\end{equation}

The following approach is taken in the SeaWiFS/MODIS atmospheric correction algorithm to retrieve $\rho_w$. For Case 1 water (e.g. open ocean), the contribution of the water $\rho_{w}$ to the total reflectance $\rho_t$ in the NIR is negligible. This fact is used to estimate $\rho_{am}$ in the NIR bands, and then these results are extrapolated to the visible bands using aerosol modeling. Finally, if $T_v$ is estimated, the $\rho_w$ in the visible bands can be computed.

There are two different approaches to determine the $\rho_{am}(\lambda)$ term at this point. The first one is to use a single-scattering approximation for $\rho_{am}(\lambda)$. The second one is to determine the multiple-scattering term $\rho_{am}(\lambda)$ based in the single scattering approximation, assuming that there exist a linear relationship between them. Both approaches are described below.

% -------------------
\subsubsection{Single Scattering}
\label{subsubsec:singlescat}
The aerosol is highly variable, and unlike the Rayleigh scattering component $\rho_r$, its effect in the total signal cannot be known {\it a priori} (\cite{Gordon:1994}). One of the first efforts to overcome this problem was developed for the CZCS atmospheric correction algorithm using a single-scattering approximation for calculating the aerosol effect in the total signal. Its logic is as follow. If the optical thickness of the atmospheric is considered $<<1$, then the term $\rho_a$ can be replaced by is single-scattering value $\rho_{as}$ (the $\rho_{ra}$ is ignored since it is a term related to multiple scattering). \autoref{eq:rhoam1} then becomes
\begin{equation}\label{eq:singleapprox}
  \rho_{am}(\lambda) = \rho_a(\lambda)+\cancel{\rho_{ra}(\lambda)} \approx \rho_{as}(\lambda)
\end{equation}
where
\begin{equation}\label{eq:rhoas}
  \begin{gathered}
    \rho_{as}(\lambda) = \frac{\omega_a(\lambda)\tau_a(\lambda)p_a(\theta,\theta_0,\lambda)}{4\cos(\theta)\cos(\theta_0)},\\  
    p_a(\theta,\theta_0,\lambda) = P_a(\theta_{-},\lambda) + [r(\theta)+r(\theta_0)]P_a(\theta_{+},\lambda),\\
    \cos(\theta_{\pm}) = \pm \cos(\theta_0)\cos(\theta)-\sin(\theta_0)\sin(\theta)\cos(\phi-\phi_0)
  \end{gathered}
\end{equation}
and $r(\lambda)$ is the Fresnel reflectance of the interface for an incident angle $\theta$, $\tau_a(\lambda)$ is the aerosol optical thickness, $\omega_a(\lambda)$ is the aerosol single-scattering albedo, $P_a(\alpha,\lambda)$ is the aerosol scattering phase function for a scattering angle $\alpha$, $\theta_0$ and $\phi_0$ are the zenith and azimuth angles from the target to the sun, respectively, and $\theta_0$ and $\phi_0$ are the zenith and azimuth angles from the target to the sensor, respectively. 


For Case 1 waters, the term $\rho_{w}$ is assumed to be zero for NIR bands. If we take the SeaWiFS case for band 7 ($\lambda_7=765nm$) and band 8 ($\lambda_8=865nm$), from \autoref{eq:rhoam}
\begin{equation}\label{eq:seawifsam7}
    \rho_{am}^{(7)} = \rho_{c}^{(7)} = \rho_{as}^{(7)},
\end{equation}
\begin{equation}\label{eq:seawifsam8}
    \rho_{am}^{(8)} = \rho_{c}^{(8)} = \rho_{as}^{(8)},
\end{equation}
where $\rho_{x}^{(i)}$ denotes a reflectance at band $i$ with wavelength $\lambda_i$. \autoref{eq:seawifsam7} and \autoref{eq:seawifsam8} mean that the aerosol reflectance term for band 7 and band 8 in SeaWiFS is equal to only the Rayleigh-corrected reflectance, which is known from the image. Now, we need to find a way to use this result to calculate the atmospheric reflectance for the rest of the bands.

\cite{Gordon:1994} define the atmospheric-correction parameter named single scattering epsilon (SSE)(\cite{IOCCG:2010}) $\varepsilon(\lambda_s,\lambda_l)$ as
\begin{equation}\label{eq:espilon}
  \varepsilon(\lambda_s,\lambda_l) \equiv \frac{\rho_{as}(\lambda_s)}{\rho_{as}(\lambda_l)} = \\
  \frac{\omega_a(\lambda_s)\tau_a(\lambda_s)p_a(\theta_v,\phi_v;\theta_0,\phi_0;\lambda_s)}{\omega_a(\lambda_l)\tau_a(\lambda_l)p_a(\theta_v,\phi_v;\theta_0,\phi_0;\lambda_l)}
\end{equation}
where the indexes ``$s$'' and ``$l$'' stand for short and long wavelength, associated with the NIR bands, i.e. $\lambda_s=756nm$ and $\lambda_l=865nm$ for SeaWiFS. If the value of $\varepsilon(\lambda_i,\lambda_l)$ for the band at $\lambda_i$ (visible bands) can be computed from $\varepsilon(\lambda_s,\lambda_l)$, then $\rho_{as}(\lambda_i)$ can be determined as
\begin{equation}\label{eq:rholambda_i}
  \rho_{as}(\lambda_i) = \varepsilon(\lambda_i,\lambda_l)\rho_{as}(\lambda_l),
\end{equation}

The next step is find a way to relate $\varepsilon(\lambda_i,\lambda_l)$ from $\varepsilon(\lambda_s,\lambda_l)$. \cite{Gordon:1994} tried to find a relationship by computing  $\varepsilon(\lambda_i,\lambda_l)$ for several aerosol models that were developed by \cite{Shettle:1979} for the LOWTRAN-6 model. \autoref{fig:epsilonvslambda} shows sample results for $\varepsilon(\lambda_i,\lambda_l)$ for SeaWiFS for these different aerosol models, where $\lambda_l=865nm$. It can be seen that over the range $412-865nm$, $\varepsilon(\lambda_i,\lambda_l)$ can be described as
\begin{equation}\label{eq:epsilonexp}
  \varepsilon(\lambda_i,\lambda_l) = \frac{\rho_{as}(\lambda_i)}{\rho_{as}(\lambda_l)} \approx exp[c(\lambda_i-\lambda_l)]
\end{equation}
where $c$ is a constant that depends on the viewing geometry and the aerosol model. 

\begin{figure}[htb]
  \centering
  \includegraphics[width=11cm,clip=true]{/Users/javier/Desktop/Javier/PHD_RIT/Latex/Proposal/Images/epsilonvslambdaGordon.png}
  \caption{$\varepsilon(\lambda,\lambda_l)$ values in natural logaritmic scale for different aerosol models and relative humidity (Note: image taken from \cite{Gordon:1997}). \label{fig:epsilonvslambda} } 
  % \vspace{0.5cm}
\end{figure}

The constant $c$ can be calculated using the known value $\varepsilon(\lambda_s,\lambda_l)$ for the NIR bands using \autoref{eq:seawifsam7} and \autoref{eq:seawifsam8}. If $c$ is known then \autoref{eq:rholambda_i} becomes
\begin{equation}\label{eq:rholambda_ifinal}
  \rho_{as}(\lambda_i) = exp[c(\lambda_i-\lambda_l)]\rho_{as}(\lambda_l),
\end{equation}

Once the aerosol single-scattering contribution is determined for the visible bands, $\rho_w$ can be calculated using \autoref{eq:rhoam}, but assuming $\rho_{am}(\lambda)\approx\rho_{as}(\lambda)$. 

The single-approximation is no longer an adequate approximation in cases where the aerosols are not at least moderately absorbing (i.e. strong continental influence) or $\tau_a(\lambda)$ is sufficiently large. Therefore, a full multiple-scattering approach is needed for a more general application.



%where $\rho_{as}^{(i)}$ for band $i$ is the single-scattering aerosol reflectance and $I=1..N$ denominates a set of $N$ simulated aerosol models obtained from, for example, an atmospheric radiative transfer model such as MODTRAN. This set of simulated aerosol models could be MODTRAN runs for different combination of particle size distribution (e.g. maritime, tropospheric, coastal, or urban), relative humidity, visibility, water vapor, etc., to simulate different atmosphere conditions that can occur in the scene.
% -------------------
\subsubsection{Multiple Scattering}
As mentioned  previously, we need to calculate this total multiple-scattering aerosol reflectance $\rho_{am}$ in order to obtain the desired water-leaving reflectance $\rho_w$. The multiple-scattering depends significantly on the aerosol model (\cite{Gordon:1997}). In the single-scattering approach previously described, the multiple-scattering was ignored and specific aerosol properties were not needed for the atmospheric correction. On the other hand, if we want to include the multiple-scattering effects in the atmospheric correction algorithm in order to obtain more accurate water reflectance $\rho_w$, it is necessary to utilize specific aerosol models. As a way to use the same reasoning used in the single-scattering algorithm, we can define multiple-scattering term as
\begin{equation}\label{eq:multscat}
  \rho_a(\lambda) + \rho_{ra}(\lambda) = K[\lambda,\rho_{as}(\lambda)]\rho_{as}(\lambda)
\end{equation}
where $K$ represents the relationship between the multiple-scattering and single-scattering. \cite{Wang:1991} has shown that a monotonic near-linear relation exists between $\rho_a(\lambda)+\rho_{ra}(\lambda)$ for the multiple-scattering model and $\rho_{as}(\lambda)$ for the single-scattering model. \cite{Gordon:1994} provided a LUT for $K[\lambda,\rho_{as}(\lambda)]$ by solving the radiative transfer equation (RTE) of a set of $N$ candidate aerosol models. These aerosol models were from, or derived from, the work of \cite{Shettle:1979}. The aerosol models are Oceanic, Maritime, Coastal and Tropospheric for different values of relative humidity (RH). The LUT was created for different sensor-sun geometry, single-scattering albedo and \AA ngstr\"{o}m exponent. The RTE is solved by using vector radiative transfer (\cite{IOCCG:2010}). For the SeaWiFS/MODIS algorithm, the $\rho_a(\lambda)+\rho_{ra}$ value for a given geometry is fit to a fourth order polynomial in the single-scattering aerosol reflectance $\rho_{as}(\lambda)$, i.e.,
\begin{equation}\label{eq:polynomial}
  \rho_a+\rho_{ra} = a\rho_{as}+b\rho_{as}^2+c\rho_{as}^3+d\rho_{as}^4
\end{equation}
where $a$, $b$, $c$ and $d$ are the constants contained in the LUT for a large number of viewing-sun geometries and for values of $\tau_a(\lambda)$ up to $0.8$.

Similar to the single-scattering approach, the assumption of negligible $\rho_w$ in the NIR allows us to determine the quantities $\rho_a(\lambda_s)+\rho_{ra}(\lambda_s)$ and $\rho_a(\lambda_l)+\rho_{ra}(\lambda_l)$ in the NIR. Once these quantities are determined from the sensor-measured values, the $\rho_{as}(\lambda)$ values for the NIR bands are estimated from these quantities using the LUT. Furthermore, because $\rho_{as}(\lambda)$ depends on aerosol phase function, single-scattering albedo, and optical thickness, this value can be computed for each aerosol model. Then, the single scattering epsilon (SSE)  values (described in \S\ref{subsubsec:singlescat}) for the NIR bands (i.e. $\varepsilon(\lambda_s,\lambda_l)$) can be calculated from the single-scattering reflectance values for each aerosol model and the measured values using \autoref{eq:espilon}. 

In order to determine multiple-scattering values in the VIS, the most appropriate aerosol models are selected by comparing the SSE computed from the sensor-measured values with the ones computed from each aerosol model. This is accomplished in the following fashion. After deriving $\varepsilon(\lambda_s,\lambda_l)$, the next step is to estimate $\varepsilon(\lambda_i,\lambda_l)$. $\varepsilon(\lambda_s,\lambda_l)$ mostly falls between those for two of the $N$ aerosol models. Therefore, $\varepsilon(\lambda_i,\lambda_l)$ is assumed to fall between the same two aerosol models proportionately in the same manner as $\varepsilon(\lambda_s,\lambda_l)$. Then, \autoref{eq:rholambda_i} is used to estimate single-scattering value in the rest of the bands from $\rho_{as}(\lambda_l)$. 

Finally, the LUT is used to transform single-scattering to multiple-scattering values to obtain $\rho_{am}(\lambda)$ and using \autoref{eq:rhoam} to obtain $\rho_w(\lambda)$. 

\missingfigure{Gordon and Wang method diagram}

A summary of the method developed by \cite{Gordon:1994} is described below.

\noindent {\bf SeaWiFS/MODIS Atmospheric Correction Summary:}
\begin{enumerate}[itemsep=2pt,parsep=2pt]
  \item Enter the atmospheric correction routine with Rayleigh-corrected reflectances $\rho_c(\lambda_s)$ and $\rho_c(\lambda_l)$.
  \item Assuming water-leaving reflectances for NIR bands are equal to zero, set multiple-scattering aerosol reflectances $\rho_{am}(\lambda_s)$ and $\rho_{am}(\lambda_l)$ equal to Rayleigh-corrected reflectances.
  \item Using the aerosol LUTs, calculate the corresponding single-scattering aerosol value at the two NIR bands, i.e. $\rho_{as}(\lambda_s)$ and $\rho_{as}(\lambda_l)$. Then, calculate the corresponding SSE.
  \item For each $N$ aerosol, compute the single-scattering value using \autoref{eq:rhoas}. Calculate corresponding SSE.
  \item Select the best two aerosol model by comparing the retrieved SSE with the theoretical SSE and determine the interpolation ratio between them.
  \item For the optimal aerosol model use the tabulated $\varepsilon(\lambda)$ in the VIS and $\varepsilon(\lambda_l)$ to obtain $\rho_{as}(\lambda)$ and then $\rho_{am}(\lambda)$ in the VIS using \autoref{eq:rholambda_i} and LUT.
  \item Remove $\rho_{am}(\lambda)$ in the VIS from $\rho_c(\lambda)$ and divide by the corresponding atmospheric transmittance that corresponds to the best aerosol model to return $\rho_w(\lambda)$ in the VIS using \autoref{eq:rhoam}.
\end{enumerate}

% ------------------------------
\subsection{SeaWiFS Algorithm for Case 2 Water}\label{subsec:ruddick}

The next atmospheric correction method is based in the method developed by Gordon~\cite{Gordon:1997} for ocean color satellites (i.e. SeaWiFS, MODIS), and extended by \cite{Ruddick:2000bs} for use over turbid coastal and inland waters (Case 2) or high productive Case 1 waters. As stated previously, the methods developed by \cite{Gordon:1994} assumes a zero water-leaving radiance for the NIR bands, which is not valid for highly turbid coastal and inland waters. Backscatter from particles in this waters could contribute to signal in the NIR bands, causing an over-estimation of the aerosol contribution and therefore an under-estimation of the water-leaving reflectances, even leading to negative values in the visible, which is not possible. 

In order to overcome this problem, \cite{Ruddick:2000bs} replaced the black water assumption with two assumptions: the assumption of spatial homogeneity of the SeaWiFS's NIR bands ratio ($765:865-nm$) for aerosol reflectance and for water-leaving reflectance. These two ratios are used as calibration parameters after inspection of the Rayleigh-corrected reflectance scatterplot. The algorithm is described in more details below.

In order to extend the standard atmospheric correction procedure to turbid water, two assumptions are used:

\begin{enumerate}[itemsep=2pt,parsep=2pt]
  \item At least over the ROI, the calibration parameter $\varepsilon_m(\lambda_s,\lambda_l)$, defined as the ratio of multiple-scattering aerosols and aerosol-Rayleigh reflectances at the NIR bands, is assumed to be spatially homogeneous, i.e.
  \begin{equation}\label{eq:rhohomo}
    \varepsilon_m(\lambda_s,\lambda_l)\equiv \frac{\rho_{am}(\lambda_s)}{\rho_{am}(\lambda_l)},
  \end{equation}
  and fixed for each image.

  \item The calibration parameter $\alpha$, defined as the ratio of water-leaving reflectances normalized by the sun-sea atmospheric transmittance at the NIR bands $T_0(\lambda)$, is assumed to be spatially homogeneous, i.e.
  \begin{equation}\label{eq:alpha}
    \alpha \equiv \frac{\rho_w(\lambda_s)/T_0(\lambda_s)}{\rho_w(\lambda_l)/T_0(\lambda_l)},
  \end{equation}
  and fixed for each image.
\end{enumerate}

By using these two assumption, the multiple-scattering aerosol and the aerosol-Rayleigh reflectance for the NIR bands can be derived as

\begin{equation}\label{eq:rhoams}
  \rho_{am}(\lambda_s) = \frac{\alpha\rho_c(\lambda_l)-\rho_c(\lambda_s)}{\alpha-\varepsilon_m(\lambda_s,\lambda_l)},
\end{equation}
and
\begin{equation}\label{eq:rhoaml}
  \rho_{am}(\lambda_l) = \varepsilon_m(\lambda_s,\lambda_l)\left[\frac{\alpha\rho_c(\lambda_l)-\rho_c(\lambda_s)}{\alpha-\varepsilon_m(\lambda_s,\lambda_l)}\right],
\end{equation}

Once these aerosol reflectances $\rho_{am}(\lambda_s)$ and $\rho_{am}(\lambda_l)$ are determined, they can be used in the standard algorithm, described in the previous section (instead of $\rho_c(\lambda_s)$ and $\rho_c(\lambda_l)$) to derive $\rho_w(\lambda)$ in the VIS.

\cite{Ruddick:2000bs} suggested to determine the calibration parameter $\varepsilon_m(\lambda_s,\lambda_l)$ by inspection of the scatterplot between the Rayleigh-corrected reflectance $\rho_c$ in the NIR bands, as shown in \autoref{fig:ruddickplot}. This assumption is only valid for small scale space, where the aerosol type varies only weakly in space. As for the calibration parameter $\alpha$, \cite{Ruddick:2000bs} set it to a default value of $1.72$, which is a first-order estimate from a greatly simplified ocean color model. The derivation can be seen in \cite{Ruddick:2000bs} and will not be explained here.

The process is summarized as follows:

\noindent {\bf SeaWiFS/MODIS Atmospheric Correction for Turbid Water Summary:}(\cite{Ruddick:2000bs})
\begin{enumerate}[itemsep=2pt,parsep=2pt]
  \item Enter the atmospheric correction routine to produce a scatter plot of Rayleigh-corrected reflectances $\rho_c(\lambda_s)$ and $\rho_c(\lambda_l)$) for the ROI of study, and select the calibration parameter $\varepsilon_m(\lambda_s,\lambda_l)$. Set calibration parameter $\alpha$ equal to 1.72.

  \item Reenter the atmospheric correction routine with $\rho_c(\lambda_s)$ and $\rho_c(\lambda_l)$ and use \autoref{eq:rhoams} and \autoref{eq:rhoams} to obtain $\rho_{am}(\lambda_s)$ and $\rho_{am}(\lambda_l)$, taking account of nonzero water-leaving reflectances.

  {\bf Note:} The following steps are the same as the standard algorithm described in \S\ref{subsec:gordon}.

  \item Using the aerosol LUTs, calculate the corresponding single-scattering aerosol value at the two NIR bands, i.e. $\rho_{as}(\lambda_s)$ and $\rho_{as}(\lambda_l)$. Then, calculate corresponding SSE.

  \item For each $N$ aerosol, compute the single-scattering value using \autoref{eq:rhoas}. Calculate corresponding SSE.
  \item Select the best two aerosol models by comparing the retrieved SSE with the theoretical SSE and determine the interpolation ratio between them.
  \item For the optimal aerosol model use the tabulated $\varepsilon(\lambda)$ in the VIS and $\varepsilon(\lambda_l)$ to obtain $\rho_{as}(\lambda)$ and then $\rho_{am}(\lambda)$ in the VIS using \autoref{eq:rholambda_i} and LUT.
  \item Remove $\rho_{am}(\lambda)$ in the VIS from $\rho_c(\lambda)$ and divide by the corresponding atmospheric transmittance that corresponds to the best aerosol model to return $\rho_w(\lambda)$ in the VIS using \autoref{eq:rhoam}.
\end{enumerate}

\begin{figure}[htb]
  \centering
  \includegraphics[width=10cm]{/Users/javier/Desktop/Javier/PHD_RIT/Latex/Proposal/Images/RuddickPlot.png}
  \caption{Scatterplot of Rayleigh-corrected reflectances at 765 and 865 nm for an subregion in a SeaWiFS image taken 28 October 1997, 12:15 UTC.  (Note: image taken from \cite{Ruddick:2000bs}). \label{fig:ruddickplot} } 
\end{figure}
% The second atmospheric correction method will be an extension of a method developed for SeaWiFS over turbid coastal and inland waters \cite{Ruddick:2000bs}. This method is a modified version of the methods developed by Gordon \cite{Gordon:1997} for ocean color satellites, but when the signal leaving the water does contribute to the overall signal beyond the NIR part of the spectrum. By using longer wavelengths and restricting the input pixels to open waters, these methods can be  applied to many fresh and coastal regions. The water surface reflectance values obtained after atmospheric correction will be validated through comparison to water surface reflectance measured in situ. 

% ------------------------------
\subsection{SWIR bands Atmospheric Correction}\label{subsec:wang}

For Case 2 or high productive Case 1 waters, especially turbid waters, there is a significant contribution from the water-leaving radiance and hence the zero water-leaving assumption in the NIR bands is not valid anymore. This is often the case in inland and coastal waters and therefore the NIR bands cannot be used to atmospherically correct this kind of imagery. However, these kinds of waters are indeed black in the shortwave infrared (SWIR) bands ($\geq 1000nm$) due to stronger water absorption. So, we can use the same atmospheric correction procedure used for SeaWiFS and MODIS but replacing the NIR bands with the two OLI's SWIR band ($1690$ and $2200nm$) for the data processing, as suggested by \cite{Wang:2007,Wang:2005}. \cite{Wang:2007} evaluated different combinations of the MODIS' SWIR bands to atmospherically correct a specific study image and compared the results with the traditional algorithm (NIR bands). Actually, the latest MODIS atmospheric algorithm uses a NIR-SWIR combined atmospheric correction approach that uses the NIR bands for Case 1 non-high productive water and the SWIR bands for Case 2 or high productive Case 1 waters, and a turbidity index to decide when to use them (\cite{Wang:2007dz}). 

% ------------------------------
\subsection{OLI Algorithm for Case 2 Waters (Blue Band)}
\cite{GeraceThesis} proposed to use a combination of spectral matching and band ratio techniques (method developed by \cite{Gordon:1997}) to atmospherically correct OLI data over Case 2 waters. A requirement to use band ratio technique for atmospherically correct OLI data is $\varepsilon^{(1,6)}\cong constant$, or in other words the ratio of reflectance from OLI's band 1 (coastal band) and band 6 (SWIR 1 band) should be approximately constant for all water pixels in the region of interest. Due to variability in band 1, the previous requirement is not always true. However, this variability can be accounted using spectral matching. This method needs to be applied with caution as it will not work in highly turbid water due to high variability in band 1. Therefore, an {\it a priori} analysis of the band histogram is needed, and only the bands whose histogram has little spread and resemble a normal distribution should be used.

This method first uses a forwarding modeling to create a three dimensional (3-D) LUT. Then, it adds atmospheric visibility as a fourth dimension (4-D). First, a 3-D LUT is created using Hydrolight. The dimensions are concentration of chlorophyll-{\it a}, suspended particles and CDOM. The range of the LUT is made up of spectral water-leaving reflectances. Then, this 3-D reflectance LUT is propagated to the TOA using MODTRAN for a range of visibilities. Therefore, the 4-D LUT will be made up of the independent variables chlorophyll-{\it a}, suspended particles, CDOM and visibility, while the range will be made up of spectral sensor-reaching radiances. A diagram showing the concept of this 4-D LUT is shown in \autoref{fig:4DLUT}. Note that this approach requires some knowledge of the aerosol type (e.g. rural, urban, maritime, etc.). Furthermore, the sensor-reaching radiances should be spectrally sampled by the OLI's sensor response and the data from the image should corrected for glint effect before comparing with the 4-D LUT since it does not include this effect.

\begin{figure}[htb]
  \centering
  \includegraphics[width=14cm]{/Users/javier/Desktop/Javier/PHD_RIT/Latex/Proposal/Images/4DLUT.png}
  \caption{Four dimensional LUT. The dimension are concentrations of chlorophyll-{\it a}, suspended particles, CDOM and visibility and the range is spectral sensor-reaching radiance. Source: \cite{GeraceThesis}}
  \label{fig:4DLUT} 
\end{figure}\todo{change figure for a better quality}

Once the 4-D LUT has been created, an iterative search of the closest match to an imaged water pixel is performed. The first step in this iteration is to obtain an initial guess of the visibility. To do so an imaged spectrum is compared to the spectra contained in the 4-D LUT. The parameters (concentration of CPAs and visibility) associated to the closest non-interpolated spectrum in the 4-D LUT in a RMS sense are associated with the imaged spectrum. Then, these associated parameters are fixed and the observed $\varepsilon^{(1,6)}$ is compared with the 4-D LUT $\varepsilon^{(1,6)}$ values for different visibility but same concentration, and the visibility of the closest match is selected as initial visibility estimate.

After estimating the initial visibility, an optimization routine can be used to estimate the four parameters from the 4-D LUT by interpolation. The final result of this process are interpolated CPA's concentration and visibility associated with the imaged pixel.

\cite{GeraceThesis} suggests using an average of all visibility solutions obtained previously as a fixed visibility and repeat the estimation described above with this fixed visibility. This is because the atmosphere should not have a high variability in the scene and therefore be approximately constant over the study region.

A summary of this process is described below.

\noindent{\bf Summary:}
Enter the algorithm with glint corrected data:\\
{\bf Step 1:} Using the three dimensions of chlorophyll-{\it a}, particles and CDOM concentrations, create a water-leaving reflectance 3-D LUT using Hydrolight.\\
\noindent{\bf Step 2:} Propagate the 4-D LUT to the TOA using MODTRAN to develop a 4-D LUT of sensor-reaching radiances. Use a best-estimate aerosol type and a range of visibility.\\
\noindent{\bf Step 3:} Search best match of imaged water pixel in the 4-D LUT.\\
\noindent{\bf (a)} Obtain initial guess of the visibility by using spectral matching and epsilon ratios.\\
\noindent{\bf (b)} Search for best match in the 4-D LUT using initial guess of the visibility.\\
\noindent{\bf Step 4:} Obtain average visibility from all the water pixel and repeat search for best match.\\

% ------------------------------
\subsection{OLI Algorithm for Case 2 Waters (Band Ratios)}
Another algorithm suggested by \cite{GeraceThesis} uses the concept adopted by \cite{Ruddick:2000bs}, but using OLI's NIR (band 5) and SWIR 1 (band 6) bands instead of the two NIR bands used for SeaWiFS. This algorithm utilizes the concept of band ratios (using the epsilon ratio values) in its implementation for calculating the reflectance due to aerosol in the scene. Recall from \cite{Ruddick:2000bs} that we would like $\varepsilon^{(i,j)}$ to be constant over the region of interest, for some band $i$ and band $j$. 

For this algorithm specifically, the requirement should be $\varepsilon^{(5,6)}\cong constant$. If this is the case for any two band in the scene, then a band ratio technique (\S\ref{subsec:gordon}, \S\ref{subsec:ruddick} and \S\ref{subsec:wang}) can be used to solve for $\rho_w$ in \autoref{eq:rhoam}. However, the requirement of $\varepsilon^{(5,6)}\cong constant$ could not be true for turbid waters because there are some signal coming from the water in the NIR and not only from the atmosphere, i.e. $\rho_w^{(5)}\neq0$. This fact produces variability in the water reflectance in band 5. Therefore, simply calculating $\varepsilon^{(5,6)}$ will result in a misrepresentation of the atmosphere and the water signal. A solution to this problem is to select the signal in band 5 (NIR band; $862nm$) from a region of dark waters, and make the black pixel assumption in the band 6. This will allow to calculate $\varepsilon^{(5,6)}$ over a dark water and therefore determine its atmosphere signal, i.e. the \cite{Ruddick:2000bs} approach adapted to the SWIR region. Then, the whole water scene is assumed to have the chosen atmosphere, the image is atmospherically correct for that atmosphere. The details of this algorithm are similar to the ones described in \cite{Ruddick:2000bs} (see \S\ref{subsec:ruddick}), and summarized below.

\noindent{\bf Summary:}
Enter the algorithm with glint corrected data:\\
{\bf Step 1:} Create a LUT of aerosol reflectances for different atmospheric models using MODTRAN and Hydrolight to determine $\rho_w$ for a dark water pixel. Then, calculate $\varepsilon^{(5,6)}$ for each atmospheric model in the LUT. \\
\noindent{\bf Step 2:} Calculate an averaged $\varepsilon^{(5,6)}$ from a region of interest over dark water by averaging the reflectance at the TOA ($\rho$) values for that region.\\ 
\noindent{\bf Step 3:} Use the averaged $\varepsilon^{(5,6)}$ to find the closest two matches for the modeled atmosphere in the LUT from Step 1 and calculate the interpolation ratio between these two matched and the averaged $\varepsilon^{(5,6)}$. \\
\noindent{\bf Step 4:} Extrapolate the determined model to all wavelengths using interpolation ratio. \\
\noindent{\bf Step 5:} Globally correct the scene for the atmospheric effect. \\
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% -----------------------------------------------
\section{In-Water Constituent Retrieval Process}
\label{sec:retrieval}
The retrieval algorithm will be based on previous work done by Gerace {\it et al.} \cite{Gerace:2013} and Raqueno {\it et al.} \cite{Raqueno:2000}. The water surface reflectance product obtained after atmospheric correction from the previous stage is used as input to the retrieval algorithm. Each pixel in the reflectance product has an unknown concentration. A spectral matching technique is applied to predict this concentration by comparing the spectral shape of each pixel with the elements in a look-up table (LUT). The complete retrieval process will be explained in the following sections. 
% -------------------------------------
\subsection{LUT generation}
The LUT is generated in Ecolight~\cite{MobleyHE} for different triplets of water constituent concentrations (CPAs). Ecolight was used in the same fashion as in the black pixel determination for the model-based ELM (\S\ref{subsubsec:blackpixel}). \autoref{tab:LUTconc2} shows the different parameters used to create the LUT in Ecolight. Two different sets of IOPs (mass-specific absorption and scattering spectra) were used, one set for modeling the open lake conditions (low concentration of CPAs) and one set for modeling the pond condition (high concentration of CPAs)\todo{show IOPs figures}. These IOPs are labeled in \autoref{tab:LUTconc2} as ``ONTNS'' for the open lake conditions and as ``LONGS'' for the pond conditions. \autoref{tab:LUTconc2} also shows the CPAs concentration used to create the LUT in Ecolight. Furthermore, discretized Fournier-Forand phase function with four different backscatter fraction values ($0.5$, $1.0$, $1.5$ and $2.0\%$) were used to account for the backscattering variability in the scene.


\begin{table}[htb]
\caption{ Input parameters for the LUT generation in Ecolight. \label{tab:LUTconc2} } 
\centering
		\begin{tabular}{c|c|c|c|c}
        		\bfseries{$<CHL>$}  	& \bfseries{$<SM>$}  & \bfseries{$a_{CDOM}(440)$} & \bfseries{$Backscatter$} & IOPs Input\\
		$[ug/L]$  		& $[mg/L]$ & 	$[1/m]$ &	\bfseries{$Fraction$}, $[\%]$	\\ \hline \hline
0.1   & 1.0  &  0.11 &  0.5 & ONTNS\\
0.5   & 2.0  &  0.15 &  1.0 & LONGS\\
1.0   & 5.0  &  0.21 &  1.5 & --\\
3.0   & 10.0 &  0.6  &  2.0 & --\\
10.0  & 25.0 &  1.0  &  --  & --\\
20.0  & 45.0 &  1.2  &  --  & --\\
40.0  & 50.0 &  --   &  --  & --\\
60.0  & --   &  --   &  --  & --\\  
90.0  & --   &  --   &  --  & --\\  
110.0 & --   &  --   &  --  & --\\  
135.0 & --   &  --   &  --  & --\\  
150.0 & --   &  --   &  --  & --\\     
	 	\end{tabular}
	\end{table}

After obtaining the LUT from Ecolight, the spectral curves in the LUT are spectrally sampled to the OLI's spectral response. An example of a LUT created in Ecolight is shown in \autoref{fig:LUT} with 2000 spectral curves. 

\begin{figure}[htb]
    \centering
      \includegraphics[height=7cm]{/Users/javier/Desktop/Javier/PHD_RIT/ConferencesAndApplications/2014_ASPRS_SOY/Images/LUT.eps}
      \caption{LUT created in HydroLight}
      \label{fig:LUT}
\end{figure}

% \begin{figure}[htb]
%   	\centering
%   	\includegraphics[height=7cm]{/Users/javier/Desktop/Javier/PHD_RIT/Latex/Proposal/Images/CHLaastLONGSJavier.eps}
%   \caption{Chlorophyll mass-specific absorption spectra used to create the LUT in HydroLight. \label{fig:CHLaastLONGS} } 
% \end{figure}


% \begin{figure}[htb]
%   	\centering
%   	\includegraphics[height=7cm]{/Users/javier/Desktop/Javier/PHD_RIT/Latex/Proposal/Images/astar_CDOM_LONGS091913.eps}
%   \caption{CDOM mass-specific absorption spectra used to create the LUT in HydroLight. \label{fig:CDOMaastLONGS} } 
% \end{figure}

% \begin{figure}[htb]
%   	\centering
%   	\includegraphics[height=7cm]{/Users/javier/Desktop/Javier/PHD_RIT/Latex/Proposal/Images/astar_SM_LONGS091913.eps}
%   \caption{SM mass-specific absorption spectra used to create the LUT in HydroLight. \label{fig:SMaastLONGS} } 
% \end{figure}
\subsection{Retrieval}
Two methods are investigated for performing the retrieval. The first one is using the root mean squared error (RMSE) to determine the concentrations based in the closest element in the LUT. This method gives discretized concentration values corresponding to the LUT concentration values. The second one uses a non-linear optimization to estimate these values. This method gives continuous concentration values based in a trilinear interpolation that interpolated between the closest matches in the LUT.
% -----------------------------------------
\subsubsection{Root Mean Square Error}
In this work, the RMSE is defined as
\begin{equation}
  RMSE(i) = \sqrt{\frac{1}{m}\sum_1^m\left[\widetilde{R}_{rs}(i,\lambda_m)-R_{rs}(\lambda_m)\right]^2}
\end{equation}
where $\widetilde{R}_{rs}(i,\lambda_m)$ is the $i$th database spectrum from the LUT at wavelength band $m$ and $R_{rs}(\lambda_m)$ is the measured spectrum for a particular image pixel. For each pixel in the image, the RMSE error is calculated with every $i$th element in the LUT. Then, the element of the LUT that results in the lowest RMSE is chosen as the concentration for that particular pixel. This method gives discretized values for the concentrations equal to the values used to create the LUT.

% -----------------------------------------
\subsubsection{Non-linear Optimization}
\todo{Mention: water mask and RMSE} 
The spectral matching is made by a least square error minimization algorithm using the ``\texttt{lsqnonlin}'' package of the MATLAB's Optimization Toolbox. \texttt{lsqnonlin} solves least-squares problems, including nonlinear data-fitting problems \todo{cite Matlab Help}. If $f(x)$ is a user-defined vector function defined as
\begin{equation}
  f(x)=
  \left[
    \begin{array}{c}
      f_1(x) \\
      f_2(x) \\
      \vdots \\
      f_m(x) \\
    \end{array}
  \right],
\end{equation}
with $x$ a vector. \texttt{lsqnonlin} tries to minimize the function
\begin{equation}
  \underset{x}{min}\parallel f(x) \parallel^2_2=\underset{x}{min}(f_1(x)^2+f_2(x)^2+f_3(x)^2+...+f_m(x)^2)
\end{equation}
In this case, $x$ is the three CPA concentrations and the function $f(x)$ is the difference between the water spectra $R_{rs}$ for each pixel and an estimated curve $F$ from the LUT, this is
\begin{equation}
  f = R_{rs} - F
\end{equation}
where $F$ is obtained from a trilinear interpolation based in the CPA concentrations of the LUT. The dimension $m$ is the number of bands. In other words, for each pixel in the image, \texttt{lsqnonlin} tries to find a function that minimizes the error between the measured value and an interpolated spectra from the LUT. \texttt{lsqnonlin} stops the search after reaching certain threshold. 

The output of this process is a concentration mapping for each water constituent that spans the range of constituents levels in the scene. 

\section{Ground Truth Data Collection}
The area of study for this research is the Lake Ontario Rochester Embayment (latitude: 4315'32.53"N and longitude: 7736'13.10"W), which includes some nearby ponds (Long and Cranberry Ponds), the Genesee River plume, the Irondequoit Bay and the southern end of Lake Ontario, as shown in Figure~\ref{fig:areaofstudy1} and Figure~\ref{fig:areaofstudy2}. This area was selected because it exhibits a wide range of variability in concentration of water constituents, so the retrieval algorithm can be tested with different scenarios. Landsat-8 images from this area of study and corresponding water samples collected at the time of the satellite's overpass will be used to test the retrieval algorithm. So far, there are only three satisfactory images available from the summer 2013. This project contemplates performing one new ground truth data collection during 2014. Therefore, images from the 2013-2014 spring and summer collection seasons will be used to test the methodology. Note that a difficult challenge of this research is to obtain images with relatively clear weather conditions (i.e. cloud free) over the area of study.
\begin{figure}[htb]
  \centering
  \includegraphics[height=9cm]{/Users/javier/Desktop/Javier/PHD_RIT/Latex/Proposal/Images/AreaOfStudy1.pdf}
  \caption{Area of Study. \label{fig:areaofstudy1} } 
\end{figure}
\begin{figure}[htb]
  \centering
  \includegraphics[height=7cm]{/Users/javier/Desktop/Javier/PHD_RIT/Latex/Proposal/Images/AreaOfStudy2.pdf}
  \caption{Area of Study. \label{fig:areaofstudy2} } 
\end{figure}

In order to have outputs in HydroLight that are representative of the water bodies that are being studied, inherent optical properties (IOPs) of those specific waters have to be defined as input to the HydroLight model. After collection, these water samples need to be analyzed in the lab to obtain IOPs for the main water constituents. Furthermore, apparent optical properties (AOPs) (i.e. water surface reflectance) and backscattering measurements will be also collected for further comparison and to pursue closure between the HydroLight AOPs results and in-situ AOPs measurements.

\section{Validation}
The results from the retrieval process will be validated by comparison with the concentration of water samples taken during field campaigns in the spring and summer of 2013 and 2014. These concentrations will be obtained from lab measurements made at the Rochester Institute of Technology. For further validation, the results will be compared with products derived from ocean color satellites such as MODIS (e.g. MODIS Chl-{\it a} product), in regions where it is possible. 

Additionally, the results will be compared with the products derived in the SeaWiFS Data Analysis System (SeaDAS) software for Landsat-8, which is contemplated to be launched soon (more info: \url{http://seadas.gsfc.nasa.gov/}). The latest version (SeaDAS 7.0.2) is a comprehensive image analysis package for the processing, display, analysis, and quality control of ocean color data developed by the developers of ESA's BEAM software package and the Ocean Biology Processing Group (OBPG) at NASA. If this capability is launched in the next version of SeaDAS, Landsat-8 level L1 and L2 data could potentially be  atmospherically corrected using the method used for MODIS \cite{Gordon:1994,Ruddick:2000bs,Wang:2007dz}, and therefore L3 data (e.g. Chl-{\it a} product) could be obtained from Landsat-8 images.
% \section{OLI Sensor}
% \subsection{Sensor Response}
% Noise level. Quantization. SNR.

% \section{Retrieval Process}
% \subsection{The Look-Up Table}


% \subsubsection{Real Atmosphere Conditions}

% \section{Over-Water Atmospheric Compensation}
% \subsection{Model Based Empirical Line Method}

% \subsubsection{Pseudo Invariant Features}

% This model employs pseudo-invariant feature (PIF) pixels extraction from the Landsat Climate Data Record (CDR) Surface Reflectance product along with an in-water radiative transfer model (HydroLight) to obtain the field spectra to be used in the ELM method. 
%  A mask is created applying a threshold a the ratio between the NIR band and the red band. 
%  A mask is created applying a threshold to the SWIR 2 band. 

% The model based empirical line method (MBELM) atmospheric correction method is based in the well known empirical line method (ELM).

% \subsection{LUT Method}


\section{Concluding Remarks}
The purpose of this chapter was to introduce the methodology required to achieve the objectives defined in the Chapter \S\ref{ch:objectives}. First, we began by explaining the different atmospheric correction techniques that will be investigated in this research along with the solar-glint removal algorithm. These atmospheric correction techniques include two different approaches. The first approach are methods applied to ocean color satellites. The second one is the model-based ELM method. The in-water constituent retrieval process was presented. The LUT generation and the metrics used to perform the retrieval were described. Additionally, the ground truth data collection was briefly explained. Finally, how the results will be validated was described. 

The next Chapter (\S\ref{ch:results}) will present the data and laboratory measurements available to date, along with preliminary results. These results include the atmospheric correction applied to Landsat-8 imagery, concentration of CPAs maps.


